![](https://s3.leryn.top/website/image/confluence.svg#crop=0&crop=0&crop=1&crop=1&id=cQI6E&originHeight=324&originWidth=2500&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)
<a name="CXuxx"></a>
# Confluence
参考文档:

- [Conflunce - 官网](https://www.atlassian.com/zh/software/confluence)
<a name="JgNCK"></a>
## Docker 安装
<a name="tvHzu"></a>
### Docker 镜像安装

官方镜像提供了镜像 [atlassian/confluence-server](https://hub.docker.com/r/atlassian/confluence-server), 提供了完善的配置和解决方案.<br />我们使用一个热门的第三方 [haxqer/confluence](https://hub.docker.com/r/haxqer/confluence).

```bash
docker run \
  --detach=true \
  --env=TZ='Asia/Shanghai' \
  --publish=8090:8090 \
  --volume=/data/confluence:/var/confluence \
  --volume=/conf/confluence:/opt/confluence/conf \
  --name=confluence \
  --hostname=confluence \
  haxqer/confluence:latest
```

容器启动成功后进入对应的界面, 根据界面提示操作即可. 有两步需要额外的服务端操作.
<a name="wHr4b"></a>
### 生成序列号

如果需要生成序列号, 可以使用如下命令生成序列号.

```bash
# -o 网址
# -s 服务器ID
docker exec confluence \
  java -jar /var/agent/atlassian-agent.jar \
  -p conf \
  -m haxqer666@gmail.com \
  -n haxqer666@gmail.com \
  -o https://confluence.leryn.top \
  -s B0YY-DP3U-WMSM-9HVK
```

<a name="NsbUo"></a>
### 创建数据库

创建数据库, 这里选择 MySQL:

注意 confluence 对字符集和事务隔离等级有要求.<br />创建数据库, 注意要指定字符集`utf8`和排序字符集`utf8_bin`, 其他都是常规操作.

```sql
CREATE USER confluence@'%' IDENTIFIED BY 'confluence@123' WITH GRANT OPTION;
CREATE DATABASE IF NOT EXISTS confluence DEFAULT CHARACTER SET utf8 COLLATE utf8_bin;
GRANT ALL PRIVILEGES ON confluence.* TO confluence@'%' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

利用 JDBC URL 设置事务隔离等级.

```
jdbc:mysql://leryn.top:3306/confluence?sessionVariables=transaction_isolation='READ-COMMITTED'&useSSL=false&allowPublicKeyRetrieval=true
```

<a name="GcEYF"></a>
### 修改 JVM 内存限制(可选)

默认的 JVM 内存限制最大最小内存都是 1024M. 4G 贫民服务器需要降低内存才能正常工作.

```bash
docker exec confluence \
            sed -i 's/-Xms[0-9]*m -Xmx[0-9]*m/-Xms1024m -Xmx1024m/p' /opt/confluence/bin/setenv.sh
docker restart confluence
```

<a name="yXXez"></a>
### 设置 Base Url

如果使用域名访问需要把 Base URL 设置成域名, 而不是 IP 地址加端口的形式. 或者再一开始生成序列号的时候就填写域名.<br />参考官方文档:

- [更多关于服务器基础 URL - 官方文档](https://confluence.atlassian.com/conf76/configuring-the-server-base-url-1018769760.html)
- [在 Confluence 6.6 或更高版本中无法检查基本 URL 警告 - 官方文档](https://confluence.atlassian.com/confkb/can-t-check-base-url-warning-in-confluence-6-6-or-later-939718433.html)

站点管理 -> 一般配置 -> 一般配置 -> 服务器主页 URL 修改为`[https://<subdomain>.<domain>.com](https://%3Csubdomain%3E.%3Cdomain%3E.com)`并提交.<br />同时修改**${CONF_HOME}**/conf/server.xml 的配置文件,

```bash
docker cp confluence:/opt/confluence/conf/server.xml .

vim server.xml
```

注释以下部分:

```xml
<Connector port="8090" connectionTimeout="20000" redirectPort="8443"
            maxThreads="48" minSpareThreads="10"
            enableLookups="false" acceptCount="10" debug="0" URIEncoding="UTF-8"
            protocol="org.apache.coyote.http11.Http11NioProtocol"/>
```

并取消注释以下部分, 并修改 Base URL:

```xml
<Connector port="8090" connectionTimeout="20000" redirectPort="8443"
                   maxThreads="48" minSpareThreads="10"
                   enableLookups="false" acceptCount="10" debug="0" URIEncoding="UTF-8"
                   protocol="org.apache.coyote.http11.Http11NioProtocol"
                   scheme="https" secure="true" proxyName="<subdomain>.<domain>.com" proxyPort="443"/>
```

保存并重启 Confluence:

```bash
docker cp ./server.xml confluence:/opt/confluence/conf/server.xml
docker restart confluence
```
<a name="FEXbd"></a>
## <br />二进制安装

参考文档:

- [Confluence Server 7.6 Archive 方式安装文档 - Atlassian 官网](https://confluence.atlassian.com/conf76/installing-confluence-on-linux-from-archive-file-1018769978.html)

<a name="c1Dsu"></a>
### 前置准备

- Confluence: 7.6.2, 绑定的 Tomcat 版本 9.0.33
- mysql: 5.7.36
- JDK版本: OpenJDK 8u202

二. 安装JDK

1.  OpenJDK download: [https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u202-b08/OpenJDK8U-jdk_x64_linux_hotspot_8u202b08.tar.gz](https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u202-b08/OpenJDK8U-jdk_x64_linux_hotspot_8u202b08.tar.gz) 
1.  解压缩到/usr/local/java/ 
1.  配置JAVA环境变量: /etc/profile.d/java.sh<br />export JAVA_HOME=/usr/local/java/jdk8u202-b08<br />export CLASS_PATH=![](data:image/svg+xml;utf8,%3Csvg%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20width%3D%2234.323ex%22%20height%3D%222.843ex%22%20style%3D%22vertical-align%3A%20-0.838ex%3B%22%20viewBox%3D%220%20-863.1%2014778%201223.9%22%20role%3D%22img%22%20focusable%3D%22false%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20aria-labelledby%3D%22MathJax-SVG-1-Title%22%3E%0A%3Ctitle%20id%3D%22MathJax-SVG-1-Title%22%3EEquation%3C%2Ftitle%3E%0A%3Cdefs%20aria-hidden%3D%22true%22%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-4A%22%20d%3D%22M447%20625Q447%20637%20354%20637H329Q323%20642%20323%20645T325%20664Q329%20677%20335%20683H352Q393%20681%20498%20681Q541%20681%20568%20681T605%20682T619%20682Q633%20682%20633%20672Q633%20670%20630%20658Q626%20642%20623%20640T604%20637Q552%20637%20545%20623Q541%20610%20483%20376Q420%20128%20419%20127Q397%2064%20333%2021T195%20-22Q137%20-22%2097%208T57%2088Q57%20130%2080%20152T132%20174Q177%20174%20182%20130Q182%2098%20164%2080T123%2056Q115%2054%20115%2053T122%2044Q148%2015%20197%2015Q235%2015%20271%2047T324%20130Q328%20142%20387%20380T447%20625Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-41%22%20d%3D%22M208%2074Q208%2050%20254%2046Q272%2046%20272%2035Q272%2034%20270%2022Q267%208%20264%204T251%200Q249%200%20239%200T205%201T141%202Q70%202%2050%200H42Q35%207%2035%2011Q37%2038%2048%2046H62Q132%2049%20164%2096Q170%20102%20345%20401T523%20704Q530%20716%20547%20716H555H572Q578%20707%20578%20706L606%20383Q634%2060%20636%2057Q641%2046%20701%2046Q726%2046%20726%2036Q726%2034%20723%2022Q720%207%20718%204T704%200Q701%200%20690%200T651%201T578%202Q484%202%20455%200H443Q437%206%20437%209T439%2027Q443%2040%20445%2043L449%2046H469Q523%2049%20533%2063L521%20213H283L249%20155Q208%2086%20208%2074ZM516%20260Q516%20271%20504%20416T490%20562L463%20519Q447%20492%20400%20412L310%20260L413%20259Q516%20259%20516%20260Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-56%22%20d%3D%22M52%20648Q52%20670%2065%20683H76Q118%20680%20181%20680Q299%20680%20320%20683H330Q336%20677%20336%20674T334%20656Q329%20641%20325%20637H304Q282%20635%20274%20635Q245%20630%20242%20620Q242%20618%20271%20369T301%20118L374%20235Q447%20352%20520%20471T595%20594Q599%20601%20599%20609Q599%20633%20555%20637Q537%20637%20537%20648Q537%20649%20539%20661Q542%20675%20545%20679T558%20683Q560%20683%20570%20683T604%20682T668%20681Q737%20681%20755%20683H762Q769%20676%20769%20672Q769%20655%20760%20640Q757%20637%20743%20637Q730%20636%20719%20635T698%20630T682%20623T670%20615T660%20608T652%20599T645%20592L452%20282Q272%20-9%20266%20-16Q263%20-18%20259%20-21L241%20-22H234Q216%20-22%20216%20-15Q213%20-9%20177%20305Q139%20623%20138%20626Q133%20637%2076%20637H59Q52%20642%2052%20648Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-48%22%20d%3D%22M228%20637Q194%20637%20192%20641Q191%20643%20191%20649Q191%20673%20202%20682Q204%20683%20219%20683Q260%20681%20355%20681Q389%20681%20418%20681T463%20682T483%20682Q499%20682%20499%20672Q499%20670%20497%20658Q492%20641%20487%20638H485Q483%20638%20480%20638T473%20638T464%20637T455%20637Q416%20636%20405%20634T387%20623Q384%20619%20355%20500Q348%20474%20340%20442T328%20395L324%20380Q324%20378%20469%20378H614L615%20381Q615%20384%20646%20504Q674%20619%20674%20627T617%20637Q594%20637%20587%20639T580%20648Q580%20650%20582%20660Q586%20677%20588%20679T604%20682Q609%20682%20646%20681T740%20680Q802%20680%20835%20681T871%20682Q888%20682%20888%20672Q888%20645%20876%20638H874Q872%20638%20869%20638T862%20638T853%20637T844%20637Q805%20636%20794%20634T776%20623Q773%20618%20704%20340T634%2058Q634%2051%20638%2051Q646%2048%20692%2046H723Q729%2038%20729%2037T726%2019Q722%206%20716%200H701Q664%202%20567%202Q533%202%20504%202T458%202T437%201Q420%201%20420%2010Q420%2015%20423%2024Q428%2043%20433%2045Q437%2046%20448%2046H454Q481%2046%20514%2049Q520%2050%20522%2050T528%2055T534%2064T540%2082T547%20110T558%20153Q565%20181%20569%20198Q602%20330%20602%20331T457%20332H312L279%20197Q245%2063%20245%2058Q245%2051%20253%2049T303%2046H334Q340%2038%20340%2037T337%2019Q333%206%20327%200H312Q275%202%20178%202Q144%202%20115%202T69%202T48%201Q31%201%2031%2010Q31%2012%2034%2024Q39%2043%2044%2045Q48%2046%2059%2046H65Q92%2046%20125%2049Q139%2052%20144%2061Q147%2065%20216%20339T285%20628Q285%20635%20228%20637Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-4F%22%20d%3D%22M740%20435Q740%20320%20676%20213T511%2042T304%20-22Q207%20-22%20138%2035T51%20201Q50%20209%2050%20244Q50%20346%2098%20438T227%20601Q351%20704%20476%20704Q514%20704%20524%20703Q621%20689%20680%20617T740%20435ZM637%20476Q637%20565%20591%20615T476%20665Q396%20665%20322%20605Q242%20542%20200%20428T157%20216Q157%20126%20200%2073T314%2019Q404%2019%20485%2098T608%20313Q637%20408%20637%20476Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-4D%22%20d%3D%22M289%20629Q289%20635%20232%20637Q208%20637%20201%20638T194%20648Q194%20649%20196%20659Q197%20662%20198%20666T199%20671T201%20676T203%20679T207%20681T212%20683T220%20683T232%20684Q238%20684%20262%20684T307%20683Q386%20683%20398%20683T414%20678Q415%20674%20451%20396L487%20117L510%20154Q534%20190%20574%20254T662%20394Q837%20673%20839%20675Q840%20676%20842%20678T846%20681L852%20683H948Q965%20683%20988%20683T1017%20684Q1051%20684%201051%20673Q1051%20668%201048%20656T1045%20643Q1041%20637%201008%20637Q968%20636%20957%20634T939%20623Q936%20618%20867%20340T797%2059Q797%2055%20798%2054T805%2050T822%2048T855%2046H886Q892%2037%20892%2035Q892%2019%20885%205Q880%200%20869%200Q864%200%20828%201T736%202Q675%202%20644%202T609%201Q592%201%20592%2011Q592%2013%20594%2025Q598%2041%20602%2043T625%2046Q652%2046%20685%2049Q699%2052%20704%2061Q706%2065%20742%20207T813%20490T848%20631L654%20322Q458%2010%20453%205Q451%204%20449%203Q444%200%20433%200Q418%200%20415%207Q413%2011%20374%20317L335%20624L267%20354Q200%2088%20200%2079Q206%2046%20272%2046H282Q288%2041%20289%2037T286%2019Q282%203%20278%201Q274%200%20267%200Q265%200%20255%200T221%201T157%202Q127%202%2095%201T58%200Q43%200%2039%202T35%2011Q35%2013%2038%2025T43%2040Q45%2046%2065%2046Q135%2046%20154%2086Q158%2092%20223%20354T289%20629Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-45%22%20d%3D%22M492%20213Q472%20213%20472%20226Q472%20230%20477%20250T482%20285Q482%20316%20461%20323T364%20330H312Q311%20328%20277%20192T243%2052Q243%2048%20254%2048T334%2046Q428%2046%20458%2048T518%2061Q567%2077%20599%20117T670%20248Q680%20270%20683%20272Q690%20274%20698%20274Q718%20274%20718%20261Q613%207%20608%202Q605%200%20322%200H133Q31%200%2031%2011Q31%2013%2034%2025Q38%2041%2042%2043T65%2046Q92%2046%20125%2049Q139%2052%20144%2061Q146%2066%20215%20342T285%20622Q285%20629%20281%20629Q273%20632%20228%20634H197Q191%20640%20191%20642T193%20659Q197%20676%20203%20680H757Q764%20676%20764%20669Q764%20664%20751%20557T737%20447Q735%20440%20717%20440H705Q698%20445%20698%20453L701%20476Q704%20500%20704%20528Q704%20558%20697%20578T678%20609T643%20625T596%20632T532%20634H485Q397%20633%20392%20631Q388%20629%20386%20622Q385%20619%20355%20499T324%20377Q347%20376%20372%20376H398Q464%20376%20489%20391T534%20472Q538%20488%20540%20490T557%20493Q562%20493%20565%20493T570%20492T572%20491T574%20487T577%20483L544%20351Q511%20218%20508%20216Q505%20213%20492%20213Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMAIN-2F%22%20d%3D%22M423%20750Q432%20750%20438%20744T444%20730Q444%20725%20271%20248T92%20-240Q85%20-250%2075%20-250Q68%20-250%2062%20-245T56%20-231Q56%20-221%20230%20257T407%20740Q411%20750%20423%20750Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-6C%22%20d%3D%22M117%2059Q117%2026%20142%2026Q179%2026%20205%20131Q211%20151%20215%20152Q217%20153%20225%20153H229Q238%20153%20241%20153T246%20151T248%20144Q247%20138%20245%20128T234%2090T214%2043T183%206T137%20-11Q101%20-11%2070%2011T38%2085Q38%2097%2039%20102L104%20360Q167%20615%20167%20623Q167%20626%20166%20628T162%20632T157%20634T149%20635T141%20636T132%20637T122%20637Q112%20637%20109%20637T101%20638T95%20641T94%20647Q94%20649%2096%20661Q101%20680%20107%20682T179%20688Q194%20689%20213%20690T243%20693T254%20694Q266%20694%20266%20686Q266%20675%20193%20386T118%2083Q118%2081%20118%2075T117%2065V59Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-69%22%20d%3D%22M184%20600Q184%20624%20203%20642T247%20661Q265%20661%20277%20649T290%20619Q290%20596%20270%20577T226%20557Q211%20557%20198%20567T184%20600ZM21%20287Q21%20295%2030%20318T54%20369T98%20420T158%20442Q197%20442%20223%20419T250%20357Q250%20340%20236%20301T196%20196T154%2083Q149%2061%20149%2051Q149%2026%20166%2026Q175%2026%20185%2029T208%2043T235%2078T260%20137Q263%20149%20265%20151T282%20153Q302%20153%20302%20143Q302%20135%20293%20112T268%2061T223%2011T161%20-11Q129%20-11%20102%2010T74%2074Q74%2091%2079%20106T122%20220Q160%20321%20166%20341T173%20380Q173%20404%20156%20404H154Q124%20404%2099%20371T61%20287Q60%20286%2059%20284T58%20281T56%20279T53%20278T49%20278T41%20278H27Q21%20284%2021%20287Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-62%22%20d%3D%22M73%20647Q73%20657%2077%20670T89%20683Q90%20683%20161%20688T234%20694Q246%20694%20246%20685T212%20542Q204%20508%20195%20472T180%20418L176%20399Q176%20396%20182%20402Q231%20442%20283%20442Q345%20442%20383%20396T422%20280Q422%20169%20343%2079T173%20-11Q123%20-11%2082%2027T40%20150V159Q40%20180%2048%20217T97%20414Q147%20611%20147%20623T109%20637Q104%20637%20101%20637H96Q86%20637%2083%20637T76%20640T73%20647ZM336%20325V331Q336%20405%20275%20405Q258%20405%20240%20397T207%20376T181%20352T163%20330L157%20322L136%20236Q114%20150%20114%20114Q114%2066%20138%2042Q154%2026%20178%2026Q211%2026%20245%2058Q270%2081%20285%20114T318%20219Q336%20291%20336%20325Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-65%22%20d%3D%22M39%20168Q39%20225%2058%20272T107%20350T174%20402T244%20433T307%20442H310Q355%20442%20388%20420T421%20355Q421%20265%20310%20237Q261%20224%20176%20223Q139%20223%20138%20221Q138%20219%20132%20186T125%20128Q125%2081%20146%2054T209%2026T302%2045T394%20111Q403%20121%20406%20121Q410%20121%20419%20112T429%2098T420%2082T390%2055T344%2024T281%20-1T205%20-11Q126%20-11%2083%2042T39%20168ZM373%20353Q367%20405%20305%20405Q272%20405%20244%20391T199%20357T170%20316T154%20280T149%20261Q149%20260%20169%20260Q282%20260%20327%20284T373%20353Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-78%22%20d%3D%22M52%20289Q59%20331%20106%20386T222%20442Q257%20442%20286%20424T329%20379Q371%20442%20430%20442Q467%20442%20494%20420T522%20361Q522%20332%20508%20314T481%20292T458%20288Q439%20288%20427%20299T415%20328Q415%20374%20465%20391Q454%20404%20425%20404Q412%20404%20406%20402Q368%20386%20350%20336Q290%20115%20290%2078Q290%2050%20306%2038T341%2026Q378%2026%20414%2059T463%20140Q466%20150%20469%20151T485%20153H489Q504%20153%20504%20145Q504%20144%20502%20134Q486%2077%20440%2033T333%20-11Q263%20-11%20227%2052Q186%20-10%20133%20-10H127Q78%20-10%2057%2016T35%2071Q35%20103%2054%20123T99%20143Q142%20143%20142%20101Q142%2081%20130%2066T107%2046T94%2041L91%2040Q91%2039%2097%2036T113%2029T132%2026Q168%2026%20194%2071Q203%2087%20217%20139T245%20247T261%20313Q266%20340%20266%20352Q266%20380%20251%20392T217%20404Q177%20404%20142%20372T93%20290Q91%20281%2088%20280T72%20278H58Q52%20284%2052%20289Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-70%22%20d%3D%22M23%20287Q24%20290%2025%20295T30%20317T40%20348T55%20381T75%20411T101%20433T134%20442Q209%20442%20230%20378L240%20387Q302%20442%20358%20442Q423%20442%20460%20395T497%20281Q497%20173%20421%2082T249%20-10Q227%20-10%20210%20-4Q199%201%20187%2011T168%2028L161%2036Q160%2035%20139%20-51T118%20-138Q118%20-144%20126%20-145T163%20-148H188Q194%20-155%20194%20-157T191%20-175Q188%20-187%20185%20-190T172%20-194Q170%20-194%20161%20-194T127%20-193T65%20-192Q-5%20-192%20-24%20-194H-32Q-39%20-187%20-39%20-183Q-37%20-156%20-26%20-148H-6Q28%20-147%2033%20-136Q36%20-130%2094%20103T155%20350Q156%20355%20156%20364Q156%20405%20131%20405Q109%20405%2094%20377T71%20316T59%20280Q57%20278%2043%20278H29Q23%20284%2023%20287ZM178%20102Q200%2026%20252%2026Q282%2026%20310%2049T356%20107Q374%20141%20392%20215T411%20325V331Q411%20405%20350%20405Q339%20405%20328%20402T306%20393T286%20380T269%20365T254%20350T243%20336T235%20326L232%20322Q232%20321%20229%20308T218%20264T204%20212Q178%20106%20178%20102Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-6F%22%20d%3D%22M201%20-11Q126%20-11%2080%2038T34%20156Q34%20221%2064%20279T146%20380Q222%20441%20301%20441Q333%20441%20341%20440Q354%20437%20367%20433T402%20417T438%20387T464%20338T476%20268Q476%20161%20390%2075T201%20-11ZM121%20120Q121%2070%20147%2048T206%2026Q250%2026%20289%2058T351%20142Q360%20163%20374%20216T388%20308Q388%20352%20370%20375Q346%20405%20306%20405Q243%20405%20195%20347Q158%20303%20140%20230T121%20120Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-72%22%20d%3D%22M21%20287Q22%20290%2023%20295T28%20317T38%20348T53%20381T73%20411T99%20433T132%20442Q161%20442%20183%20430T214%20408T225%20388Q227%20382%20228%20382T236%20389Q284%20441%20347%20441H350Q398%20441%20422%20400Q430%20381%20430%20363Q430%20333%20417%20315T391%20292T366%20288Q346%20288%20334%20299T322%20328Q322%20376%20378%20392Q356%20405%20342%20405Q286%20405%20239%20331Q229%20315%20224%20298T190%20165Q156%2025%20151%2016Q138%20-11%20108%20-11Q95%20-11%2087%20-5T76%207T74%2017Q74%2030%20114%20189T154%20366Q154%20405%20128%20405Q107%20405%2092%20377T68%20316T57%20280Q55%20278%2041%20278H27Q21%20284%2021%20287Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-74%22%20d%3D%22M26%20385Q19%20392%2019%20395Q19%20399%2022%20411T27%20425Q29%20430%2036%20430T87%20431H140L159%20511Q162%20522%20166%20540T173%20566T179%20586T187%20603T197%20615T211%20624T229%20626Q247%20625%20254%20615T261%20596Q261%20589%20252%20549T232%20470L222%20433Q222%20431%20272%20431H323Q330%20424%20330%20420Q330%20398%20317%20385H210L174%20240Q135%2080%20135%2068Q135%2026%20162%2026Q197%2026%20230%2060T283%20144Q285%20150%20288%20151T303%20153H307Q322%20153%20322%20145Q322%20142%20319%20133Q314%20117%20301%2095T267%2048T216%206T155%20-11Q125%20-11%2098%204T59%2056Q57%2064%2057%2083V101L92%20241Q127%20382%20128%20383Q128%20385%2077%20385H26Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-50%22%20d%3D%22M287%20628Q287%20635%20230%20637Q206%20637%20199%20638T192%20648Q192%20649%20194%20659Q200%20679%20203%20681T397%20683Q587%20682%20600%20680Q664%20669%20707%20631T751%20530Q751%20453%20685%20389Q616%20321%20507%20303Q500%20302%20402%20301H307L277%20182Q247%2066%20247%2059Q247%2055%20248%2054T255%2050T272%2048T305%2046H336Q342%2037%20342%2035Q342%2019%20335%205Q330%200%20319%200Q316%200%20282%201T182%202Q120%202%2087%202T51%201Q33%201%2033%2011Q33%2013%2036%2025Q40%2041%2044%2043T67%2046Q94%2046%20127%2049Q141%2052%20146%2061Q149%2065%20218%20339T287%20628ZM645%20554Q645%20567%20643%20575T634%20597T609%20619T560%20635Q553%20636%20480%20637Q463%20637%20445%20637T416%20636T404%20636Q391%20635%20386%20627Q384%20621%20367%20550T332%20412T314%20344Q314%20342%20395%20342H407H430Q542%20342%20590%20392Q617%20419%20631%20471T645%20554Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMATHI-54%22%20d%3D%22M40%20437Q21%20437%2021%20445Q21%20450%2037%20501T71%20602L88%20651Q93%20669%20101%20677H569H659Q691%20677%20697%20676T704%20667Q704%20661%20687%20553T668%20444Q668%20437%20649%20437Q640%20437%20637%20437T631%20442L629%20445Q629%20451%20635%20490T641%20551Q641%20586%20628%20604T573%20629Q568%20630%20515%20631Q469%20631%20457%20630T439%20622Q438%20621%20368%20343T298%2060Q298%2048%20386%2046Q418%2046%20427%2045T436%2036Q436%2031%20433%2022Q429%204%20424%201L422%200Q419%200%20415%200Q410%200%20363%201T228%202Q99%202%2064%200H49Q43%206%2043%209T45%2027Q49%2040%2055%2046H83H94Q174%2046%20189%2055Q190%2056%20191%2056Q196%2059%20201%2076T241%20233Q258%20301%20269%20344Q339%20619%20339%20625Q339%20630%20310%20630H279Q212%20630%20191%20624Q146%20614%20121%20583T67%20467Q60%20445%2057%20441T43%20437H40Z%22%3E%3C%2Fpath%3E%0A%3Cpath%20stroke-width%3D%221%22%20id%3D%22E1-MJMAIN-3D%22%20d%3D%22M56%20347Q56%20360%2070%20367H707Q722%20359%20722%20347Q722%20336%20708%20328L390%20327H72Q56%20332%2056%20347ZM56%20153Q56%20168%2072%20173H708Q722%20163%20722%20153Q722%20140%20707%20133H70Q56%20140%2056%20153Z%22%3E%3C%2Fpath%3E%0A%3C%2Fdefs%3E%0A%3Cg%20stroke%3D%22currentColor%22%20fill%3D%22currentColor%22%20stroke-width%3D%220%22%20transform%3D%22matrix(1%200%200%20-1%200%200)%22%20aria-hidden%3D%22true%22%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-4A%22%20x%3D%220%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-41%22%20x%3D%22633%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-56%22%20x%3D%221384%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%3Cg%20transform%3D%22translate(2153%2C0)%22%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-41%22%20x%3D%220%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20transform%3D%22scale(0.707)%22%20xlink%3Ahref%3D%22%23E1-MJMATHI-48%22%20x%3D%221061%22%20y%3D%22-213%22%3E%3C%2Fuse%3E%0A%3C%2Fg%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-4F%22%20x%3D%223632%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-4D%22%20x%3D%224395%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-45%22%20x%3D%225447%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMAIN-2F%22%20x%3D%226211%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-6C%22%20x%3D%226712%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-69%22%20x%3D%227010%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-62%22%20x%3D%227356%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-65%22%20x%3D%227785%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-78%22%20x%3D%228252%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-70%22%20x%3D%228824%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-6F%22%20x%3D%229328%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-72%22%20x%3D%229813%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-74%22%20x%3D%2210265%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-50%22%20x%3D%2210626%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-41%22%20x%3D%2211378%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-54%22%20x%3D%2212128%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMATHI-48%22%20x%3D%2212833%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%20%3Cuse%20xlink%3Ahref%3D%22%23E1-MJMAIN-3D%22%20x%3D%2213999%22%20y%3D%220%22%3E%3C%2Fuse%3E%0A%3C%2Fg%3E%0A%3C%2Fsvg%3E#card=math&code=JAVA_HOME%2Flib%0Aexport%20PATH%3D&id=u0ubO)PATH:$JAVA_HOME/bin<br />三. 安装MySQL 
1.  mysql 5.7.36 download: [https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.36-el7-x86_64.tar.gz](https://downloads.mysql.com/archives/get/p/23/file/mysql-5.7.36-el7-x86_64.tar.gz) 
1.  解压缩到/usr/local/mysql 
1.  配置mysql环境变量: /etc/profile.d/mysql.sh<br />export PATH=$PATH:/usr/local/mysql/bin 
1.  建立mysql用户以及数据文件目录：[https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html](https://dev.mysql.com/doc/refman/5.7/en/binary-installation.html)<br />$> groupadd mysql<br />$> useradd -r -g mysql -s /bin/false mysql<br />$> mkdir /data/mysql<br />$> chown mysql:mysql /data/mysql<br />$> chmod 750 mysql-files 
1.  配置/etc/my.cnf: [https://confluence.atlassian.com/conf76/database-setup-for-mysql-1018769687.html](https://confluence.atlassian.com/conf76/database-setup-for-mysql-1018769687.html)

```bash
[mysqld]
...
datadir=/data/mysql
basedir=/usr/local/mysql
character-set-server=utf8mb4
collation-server=utf8mb4_bin
default-storage-engine=INNODB
max_allowed_packet=256M
innodb_log_file_size=2GB
transaction-isolation=READ-COMMITTED
binlog_format=row
... 
```

9.  初始化数据库,启动MySQL：

```bash
bin/mysqld --initialize --user=mysql
bin/mysql_ssl_rsa_setup
bin/mysqld_safe --user=mysql &
```
<br />可选：重置root密码，建立confluence数据库账户

10.  创建confluence数据库：[https://confluence.atlassian.com/conf76/database-setup-for-mysql-1018769687.html](https://confluence.atlassian.com/conf76/database-setup-for-mysql-1018769687.html)

```bash
CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
GRANT ALL PRIVILEGES ON confluence .* TO ''@'localhost' IDENTIFIED BY ''; 
```

11.  创建目录： 

/opt/confluence: confluence安装路径

/var/confluence：confluence运行时路径

/var/agent: 破解jar包路径

2.  下载confluence 压缩包, 并解压到/opt/confluence：[https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-7.6.2.tar.gz](https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-7.6.2.tar.gz) 
2.  解压缩：<br />tar xzf /tmp/atlassian-confluence-7.6.2.tar.gz -C /opt/confluence/ --strip-components 1 
2.  解压缩并复制mysql JDBC Driver 到 /opt/confluence/confluence/WEB-INF/lib: [https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-5.1.48.tar.gz](https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-5.1.48.tar.gz) 
2.  下载破解包到 /var/agent: [https://github.com/haxqer/confluence/releases/download/v1.2.2/atlassian-agent.jar](https://github.com/haxqer/confluence/releases/download/v1.2.2/atlassian-agent.jar) 
2.  编辑/opt/confluence/confluence/WEB-INF/classes/confluence-init.properties, 指定confluence运行时路径<br />confluence.home=/var/confluence 
2.  编辑tomcat 环境变量启动脚本，注入破解包<br />/opt/confluence/bin/setenv.sh<br />line 67: CATALINA_OPTS="-javaagent:/var/agent/atlassian-agent.jar ${CATALINA_OPTS}" 
2.  启动confluence：<br />/opt/confluence/bin/start-confluence.sh<br />初始化启动之前建议打快照 
2.  登录到confluence 进行初始化：[https://confluence.atlassian.com/conf76/installing-confluence-on-linux-from-archive-file-1018769978.html](https://confluence.atlassian.com/conf76/installing-confluence-on-linux-from-archive-file-1018769978.html) 

<a name="aeEOj"></a>
### 生成序列号

```bash
java -jar /var/agent/atlassian-agent.jar -p conf \
  -m haxqer666@gmail.com -n haxqer666@gmail.com \
  -o https://confluence.leryn.top -s <your system id>
```

注意每次初始化system id均不同, 若初始化过程中关闭confluence进程会导致confluence再次启动失败

五. 配置Confluence

1. 配置Tomcat 默认Server Address: [https://confluence.atlassian.com/confkb/can-t-check-base-url-warning-in-confluence-6-6-or-later-939718433.html](https://confluence.atlassian.com/confkb/can-t-check-base-url-warning-in-confluence-6-6-or-later-939718433.html)

根据反向代理编辑 /opt/confluence/conf/server.xml

2.  因为confluence服务器关闭了外网访问，在一般配置中，关闭Confluence Atlassian Marketplace功能 
2.  将Confluence 认证方式与JIRA 链接起来： [https://confluence.atlassian.com/conf76/connecting-to-crowd-or-jira-for-user-management-1018769563.html](https://confluence.atlassian.com/conf76/connecting-to-crowd-or-jira-for-user-management-1018769563.html) 

首先配置允许访问JIRA User Server的application

在Confluence 新增JIRA类型的User Directories

注意JIRA Server URL后加端口

4.  配置日志轮替<br />$>cat /etc/logrotate.d/confluence<br />/opt/confluence/logs/catalina.out<br />/var/confluence/logs/atlassian-confluence.log<br />/var/confluence/logs/atlassian-synchrony.log<br />/var/confluence/logs/atlassian-diagnostics.log<br />{<br />missingok<br />daily<br />rotate 14<br />missingok<br />dateext<br />notifempty<br />copytruncate<br />} 

<a name="PyQxU"></a>
## 集成 Jira

参考官方文档:

- [在设置向导中配置 Jira 集成 - 官方文档](https://confluence.atlassian.com/doc/configuring-jira-integration-in-the-setup-wizard-242255467.html)

需要 Jira 管理员权限, 根据提示操作.
<a name="NJ2Ib"></a>
## 备份与恢复

参考官方文档:

- [生产备份策略 - 官方文档](https://confluence.atlassian.com/conf76/production-backup-strategy-1018769697.html)
- [手动备份站点 - 官方文档](https://confluence.atlassian.com/conf76/migrating-to-another-database-1018769689.html)

虽然 Confluence 提供了预定的 XML 备份, 但这种备份方式只适用于**小型站点**, 以及除了数据库和**目录**备份**之外**的备份.
<a name="qjKWM"></a>
### 数据库备份策略

我们建议建立一个健壮的数据库备份策略:

- 使用数据库提供的工具创建数据库的备份或转储;
- 如果您的数据库不支持在线备份，您需要在执行此操作时停止 Confluence;
- 创建主目录的文件系统备份(本地主目录和数据中心的共享主目录)

<a name="ZS9hk"></a>
### 需要备份的文件

备份整个主目录是最安全的选择，但是大多数文件和目录在启动时填充，可以忽略。至少， 必须 备份这些文件/目录：<br />以下 `${CONF_HOME}` 为 confluence 数据的根目录, 当前 docker 容器中为`/data/cofluence:/var/confluence`.

- **${CONF_HOME}/confluence.cfg.xml** 配置文件
- **${CONF_HOME}/attachment** 附件

其余目录将在启动时自动填充。您可能还想备份这些目录：

- **${CONF_HOME}/config** - 如果您修改了 ehcache.xml 文件
- **${CONF_HOME}/index** - 如果您的站点很大或重新索引需要很长时间 - 这将避免在恢复时需要完整的重新索引.主目录的位置在安装时配置并在 `confluence.init.properties` 文件中指定。对于使用自动安装程序创建的安装, 默认位置为：
   - Windows: `C:\Program Files\Atlassian\Application Data\Confluence`
   - Linux: `/var/atlassian/application-data/confluence`

仅适用于集群实例: 备份整个共享主目录是最安全的选择, 但是一些文件和目录在运行时填充并且可以忽略:

- **${CONF_HOME}/thumbnails**
- **${CONF_HOME}/viewfile**
<a name="fitQR"></a>
### 备份

- [生产备份策略 - 官方文档](https://confluence.atlassian.com/conf76/production-backup-strategy-1018769697.html)
<a name="GAX2h"></a>
### 从备份恢复

- [手动备份站点 - 官方文档](https://confluence.atlassian.com/conf76/migrating-to-another-database-1018769689.html)
